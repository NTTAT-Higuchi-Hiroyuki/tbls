# 要件定義書 - データベースコメントからの論理名・説明読み取り機能強化

## 1. 目的

コメント機能を持つデータベースに対して、スキーマコメントから論理名と説明を適切に読み取り、ドキュメントに出力する機能を強化する。現在のtblsの基本的なコメント処理機能を拡張し、より柔軟で堅牢なコメント解析システムを提供する。

## 2. 機能要件

### 2.1 必須機能

- [ ] **対象コメントフィールドの拡張**
  - 現在のTABLE,COLUMN以外のフィールド（例: INDEX, VIEW）からも論理名と説明を抽出可能にする
  - 対象オブジェクト
    - DATABASE（データベース）
    - SCHEMA（スキーマ）
    - TABLESPACE（テーブルスペース）
    - COLLATION（照合順序）
    - CONVERSION（変換）
    - LANGUAGE（プロシージャ言語）
    - TABLE（テーブル本体）
    - COLUMN（カラム）
    - CONSTRAINT（制約 — PRIMARY KEY, UNIQUE, CHECK など）
    - VIEW（ビュー）
    - MATERIALIZED VIEW（マテリアライズドビュー）
    - FOREIGN TABLE（外部テーブル）
    - FOREIGN DATA WRAPPER（外部データラッパ）
    - SERVER（外部サーバ）
    - POLICY（行レベルセキュリティポリシー）
    - PUBLICATION / SUBSCRIPTION（論理レプリケーション関連）

- [ ] **既存コメント処理の改善**
  - 現在の区切り文字ベース（「|」）の処理を維持しながら堅牢性を向上
  - エスケープ文字の適切な処理（区切り文字がコメント内に含まれる場合）
  - 空白文字の正規化（前後の空白除去、連続空白の処理）

- [ ] **多様なコメント形式への対応**
  - JSON形式のコメント解析：`{"name": "論理名", "description": "説明", "tags": ["tag1"]}`
  - YAML形式のコメント解析（インライン）
  - 複数区切り文字のサポート（「|」「::」「--」等）

- [ ] **エラーハンドリングの強化**
  - 不正なコメント形式の際の適切なフォールバック処理
  - 解析エラーのログ出力とデバッグ情報の提供
  - 部分的な解析失敗時の継続処理

- [ ] **論理名の検証とサニタイゼーション**
  - 論理名の文字数制限チェック
  - 使用可能文字の検証（特殊文字の処理）
  - 重複論理名の検出と警告

## 3. 非機能要件

### 3.1 パフォーマンス

- なし

### 3.2 セキュリティ

- なし

### 3.3 保守性

- 既存のコメント処理ロジックとの後方互換性を維持
- テストカバレッジ90%以上
- 明確なエラーメッセージとデバッグ情報

### 3.4 互換性

- 現在サポートされているすべてのデータベース（MySQL、PostgreSQL、MSSQL等）での動作
- 既存の設定ファイル（.tbls.yml）との互換性維持
- 既存のテンプレートシステムとの統合

## 4. 制約事項

### 4.1 技術的制約

- Goバージョン1.23.8以上での実装
- 外部依存ライブラリの追加は最小限に抑制
- 現在のschema.Column、schema.Tableの構造体定義を基本的に維持

### 4.2 ビジネス制約

- 既存ユーザーの.tbls.yml設定ファイルを壊さない仕様
- 現在のドキュメント生成結果との互換性確保

## 5. 成功基準

### 5.1 完了の定義

- [ ] すべてのサポート対象データベースで新機能が正常動作
- [ ] 既存のテストがすべて通過
- [ ] 新機能に対する十分なテストケースが追加済み
- [ ] パフォーマンス要件を満たす
- [ ] ドキュメント（README、設定例）が更新済み

### 5.2 受け入れテスト

- 従来の「論理名|説明」形式のコメントが正常に処理される
- JSON形式のコメントが正しく解析される
- エラーケース（不正形式）で適切にフォールバック処理される
- 生成されるMarkdownドキュメントで論理名・説明が正しく表示される

## 6. 想定されるリスク

- **パフォーマンス劣化**: コメント解析処理の複雑化によるスキーマ読み込み時間の延長
  - 対策: ベンチマークテストの実装とパフォーマンス監視
- **後方互換性の破損**: 新機能追加により既存動作が変更される可能性
  - 対策: 段階的リリースと十分な回帰テスト
- **データベース固有の問題**: 各DBの微妙なコメント仕様の違いによる不具合
  - 対策: データベース別の詳細テストケース作成

## 7. 今後の検討事項

- プラグインシステムの導入によるコメント処理の拡張性向上
- AIを活用したコメントの自動補完・改善提案機能
- ビジュアル編集インターフェースによるコメント管理
- 他のドキュメント生成ツールとの連携機能

## 8. 実装優先度

1. **高**: 既存コメント処理の堅牢性向上
2. **高**: JSON形式コメントのサポート
3. **中**: エラーハンドリングの強化
4. **中**: 論理名の検証機能
5. **低**: 多言語対応
6. **低**: カスタムパーサー機能

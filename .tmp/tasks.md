# タスクリスト - データベースコメント機能強化

## 概要

- 総タスク数: 25
- 推定作業時間: 40-50時間（5-7日間）
- 優先度: 高

## タスク一覧

### Phase 1: 準備・基盤実装 (8-10時間)

#### Task 1.1: 拡張コメントデータ構造の定義

- [ ] `schema/comment_enhanced.go`の作成
- [ ] `CommentData`構造体の実装
- [ ] `ObjectType`列挙型の定義
- [ ] JSONタグとYAMLタグの設定
- **完了条件**: CommentData構造体が定義され、基本的なフィールドアクセスが可能
- **依存**: なし
- **推定時間**: 1.5時間

#### Task 1.2: CommentParserインターフェースの定義

- [ ] `schema/comment_parser.go`の作成
- [ ] `CommentParser`インターフェースの定義
- [ ] `ParserRegistry`インターフェースの定義
- [ ] 基本的なエラー型の定義
- **完了条件**: インターフェースが定義され、コンパイルエラーなし
- **依存**: Task 1.1
- **推定時間**: 1時間

#### Task 1.3: LegacyParserの実装（既存機能強化）

- [ ] `schema/legacy_parser.go`の作成
- [ ] 既存`SplitComment`機能をLegacyParserに移植
- [ ] エスケープ文字処理の追加
- [ ] 空白文字正規化の実装
- [ ] `CommentParser`インターフェースへの準拠
- **完了条件**: 既存のコメント処理がLegacyParserで動作、テストが通過
- **依存**: Task 1.2
- **推定時間**: 2.5時間

#### Task 1.4: LegacyParserの基本テスト作成

- [ ] `schema/legacy_parser_test.go`の作成
- [ ] 既存のコメントパターンのテスト
- [ ] エスケープ処理のテスト
- [ ] 空白処理のテスト
- [ ] エラーケースのテスト
- **完了条件**: LegacyParserのテストカバレッジ90%以上
- **依存**: Task 1.3
- **推定時間**: 2時間

#### Task 1.5: JSONParserの基本実装

- [ ] `schema/json_parser.go`の作成
- [ ] JSON形式検出ロジックの実装
- [ ] 基本的なJSON解析機能
- [ ] `CommentParser`インターフェースへの準拠
- [ ] セキュリティ制限（深度制限、サイズ制限）の実装
- **完了条件**: 基本的なJSON形式コメントが解析可能
- **依存**: Task 1.2
- **推定時間**: 3時間

### Phase 2: コア機能実装 (12-15時間)

#### Task 2.1: JSONParserの完全実装

- [ ] タグ機能の実装
- [ ] メタデータ機能の実装
- [ ] エラーハンドリングの強化
- [ ] 日本語文字対応の確認
- **完了条件**: 全てのJSON機能が動作、設計書の全要件を満たす
- **依存**: Task 1.5
- **推定時間**: 2.5時間

#### Task 2.2: JSONParserのテスト作成

- [ ] `schema/json_parser_test.go`の作成
- [ ] 正常系テストケース（基本、タグ付き、メタデータ）
- [ ] 異常系テストケース（不正JSON、深度制限、サイズ制限）
- [ ] セキュリティテストケース（XSS、SQLインジェクション対策）
- [ ] 境界値テストケース
- **完了条件**: JSONParserのテストカバレッジ95%以上
- **依存**: Task 2.1
- **推定時間**: 3時間

#### Task 2.3: CommentValidatorの実装

- [ ] `schema/comment_validator.go`の作成
- [ ] 論理名の長さ検証
- [ ] 文字種検証（正規表現ベース）
- [ ] HTML特殊文字のサニタイズ
- [ ] SQLインジェクション対策
- [ ] 重複チェック機能
- **完了条件**: 全ての検証・サニタイズ機能が動作
- **依存**: Task 1.1
- **推定時間**: 3時間

#### Task 2.4: CommentValidatorのテスト作成

- [ ] `schema/comment_validator_test.go`の作成
- [ ] 論理名検証のテスト
- [ ] サニタイズ機能のテスト
- [ ] セキュリティ攻撃パターンのテスト
- [ ] 重複検出のテスト
- **完了条件**: CommentValidatorのテストカバレッジ95%以上
- **依存**: Task 2.3
- **推定時間**: 2.5時間

#### Task 2.5: EnhancedCommentProcessorの基本実装

- [ ] `schema/enhanced_comment_processor.go`の作成
- [ ] パーサー登録・管理機能
- [ ] パーサーチェーン処理（優先度順）
- [ ] フォールバック処理
- [ ] 基本的なエラーハンドリング
- **完了条件**: パーサーチェーンが動作、基本的なコメント処理が可能
- **依存**: Task 1.3, Task 2.1, Task 2.3
- **推定時間**: 3時間

### Phase 3: 機能拡張 (8-10時間)

#### Task 3.1: YAMLParserの実装

- [ ] `schema/yaml_parser.go`の作成
- [ ] YAML形式検出ロジック
- [ ] インラインYAML解析機能
- [ ] `CommentParser`インターフェースへの準拠
- [ ] エラーハンドリング
- **完了条件**: 基本的なYAML形式コメントが解析可能
- **依存**: Task 1.2
- **推定時間**: 2.5時間

#### Task 3.2: YAMLParserのテスト作成

- [ ] `schema/yaml_parser_test.go`の作成
- [ ] 正常系テストケース
- [ ] 異常系テストケース
- [ ] 境界値テストケース
- **完了条件**: YAMLParserのテストカバレッジ90%以上
- **依存**: Task 3.1
- **推定時間**: 2時間

#### Task 3.3: 設定システムの拡張

- [ ] `config/config.go`への新しい設定項目追加
- [ ] `CommentConfig`構造体の実装
- [ ] `ValidatorConfig`構造体の実装
- [ ] 既存設定との互換性確保
- [ ] デフォルト値の設定
- **完了条件**: 新しい設定項目が.tbls.ymlで設定可能
- **依存**: なし
- **推定時間**: 2時間

#### Task 3.4: EnhancedCommentProcessorの設定連携

- [ ] 設定ファイルからの設定読み込み
- [ ] パーサー有効/無効の制御
- [ ] バリデーター設定の適用
- [ ] 設定変更時の動的対応
- **完了条件**: 設定に基づく動的なパーサー制御が動作
- **依存**: Task 2.5, Task 3.3
- **推定時間**: 1.5時間

### Phase 4: 統合・検証 (8-10時間)

#### Task 4.1: Schemaオブジェクトとの統合（Column拡張）

- [ ] `schema/schema.go`への拡張メソッド追加
- [ ] `SetLogicalNameFromCommentEnhanced`メソッド実装
- [ ] 既存メソッドとの互換性確保
- [ ] エラーハンドリングの統合
- **完了条件**: 拡張されたColumnでコメント処理が動作
- **依存**: Task 2.5
- **推定時間**: 2時間

#### Task 4.2: Schemaオブジェクトとの統合（Table拡張）

- [ ] Tableオブジェクトへの拡張メソッド追加
- [ ] テーブルコメント処理の強化
- [ ] 既存機能との互換性確保
- **完了条件**: 拡張されたTableでコメント処理が動作
- **依存**: Task 4.1
- **推定時間**: 1.5時間

#### Task 4.3: Index/View/Constraintオブジェクトの対応

- [ ] Index, View, Constraintへのコメント処理追加
- [ ] 各オブジェクト固有の処理実装
- [ ] 統一的なインターフェースの提供
- **完了条件**: 全オブジェクトタイプでコメント処理が可能
- **依存**: Task 4.2
- **推定時間**: 2.5時間

#### Task 4.4: 統合テストの実装

- [ ] `schema/comment_integration_test.go`の作成
- [ ] エンドツーエンドのテストシナリオ
- [ ] 複数パーサーの連携テスト
- [ ] フォールバック処理のテスト
- [ ] 既存機能との互換性テスト
- **完了条件**: 統合テストが全て通過
- **依存**: Task 4.3
- **推定時間**: 3時間

### Phase 5: 最適化・仕上げ (8-12時間)

#### Task 5.1: パフォーマンステストの実装

- [ ] `schema/comment_benchmark_test.go`の作成
- [ ] 解析処理時間のベンチマーク
- [ ] メモリ使用量の測定
- [ ] 大規模データでのテスト
- **完了条件**: パフォーマンス要件（1ms/テーブル）を満たす
- **依存**: Task 4.4
- **推定時間**: 2.5時間

#### Task 5.2: エラーハンドリングの強化

- [ ] 詳細なエラーメッセージの実装
- [ ] ログ出力の改善
- [ ] デバッグ情報の追加
- [ ] エラー統計の収集機能
- **完了条件**: エラー時に適切な情報が提供される
- **依存**: Task 4.4
- **推定時間**: 2時間

#### Task 5.3: ドライバー統合テスト

- [ ] MySQL, PostgreSQL, SQLiteでの動作確認
- [ ] 各データベース固有のコメント形式での確認
- [ ] 既存のドライバーテストとの統合
- **完了条件**: 主要データベースで新機能が動作
- **依存**: Task 4.4
- **推定時間**: 3時間

#### Task 5.4: ドキュメント更新

- [ ] README.mdの更新（新機能の説明）
- [ ] 設定例の追加
- [ ] マイグレーションガイドの作成
- [ ] API仕様の文書化
- **完了条件**: ユーザーが新機能を理解・利用可能
- **依存**: Task 5.3
- **推定時間**: 2.5時間

#### Task 5.5: 最終検証・リリース準備

- [ ] 全テストケースの実行確認
- [ ] lintエラーの解消
- [ ] カバレッジレポートの確認
- [ ] 既存機能のリグレッションテスト
- [ ] パフォーマンステストの確認
- **完了条件**: 全ての品質基準を満たし、リリース可能状態
- **依存**: Task 5.4
- **推定時間**: 2時間

## 実装順序

1. **Phase 1 → Phase 2**: 基盤構築後、コア機能実装
2. **並行実行可能なタスク**:
   - Task 2.2 と Task 2.3 （JSONParserテストとCommentValidator）
   - Task 3.1 と Task 3.3 （YAMLParserと設定システム）
3. **クリティカルパス**: Task 1.1 → 1.2 → 1.3 → 2.5 → 4.1 → 4.4 → 5.5

## リスクと対策

- **既存機能の互換性破損**: 各Phase完了時に回帰テスト実行
- **パフォーマンス劣化**: Task 5.1で早期発見、必要に応じて最適化実装
- **JSON/YAMLライブラリの予期しない動作**: 十分なテストケースで対応
- **設定システムの複雑化**: シンプルなデフォルト設定とドキュメント充実

## 注意事項

- 各タスクはコミット単位で完結させる
- タスク完了時は`go test`と`golangci-lint`を実行
- 不明点は実装前に設計書を参照、必要に応じて確認
- 後方互換性を常に意識した実装

## 実装開始ガイド

1. このタスクリストに従って順次実装を進めてください
2. 各タスクの開始時にTodoWriteでin_progressに更新
3. 完了時はcompletedに更新
4. 問題発生時は速やかに報告してください
5. Phase完了時は統合テストを実行し、全体の動作確認を行ってください